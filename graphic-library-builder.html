<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphic Library Builder - Digital Twin Configuration</title>
    
    <!-- PrimeNG CSS -->
    <link rel="stylesheet" href="https://unpkg.com/primeng@17.3.2/resources/themes/lara-light-blue/theme.css">
    <link rel="stylesheet" href="https://unpkg.com/primeng@17.3.2/resources/primeng.min.css">
    <link rel="stylesheet" href="https://unpkg.com/primeicons@6.0.1/primeicons.css">
    
    <!-- Angular CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@angular/cdk@17.1.0/overlay-prebuilt.css">
    
    <!-- Konva.js for Canvas -->
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .top-toolbar {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.75rem 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 1fr;
            height: calc(100vh - 140px);
            gap: 0;
        }

        .left-panel {
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .canvas-area {
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .symbol-library {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .symbol-category {
            margin-bottom: 1.5rem;
        }

        .symbol-category h3 {
            font-size: 0.9rem;
            color: #666;
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            font-weight: 600;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .symbol-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 0.75rem;
            cursor: grab;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .symbol-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-1px);
        }

        .symbol-item:active {
            cursor: grabbing;
        }

        .symbol-item svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.25rem;
        }

        .symbol-item .label {
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar-btn:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .toolbar-btn.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .toolbar-btn.primary:hover {
            background: #5a6fd8;
        }

        .toolbar-btn.success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .toolbar-btn.success:hover {
            background: #218838;
        }

        .connector-line {
            stroke: #333;
            stroke-width: 2;
            fill: none;
        }

        .connector-point {
            fill: #667eea;
            stroke: white;
            stroke-width: 2;
            cursor: pointer;
        }

        .panel-header {
            background: #f1f3f4;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-zone i {
            font-size: 3rem;
            color: #999;
            margin-bottom: 1rem;
        }

        .form-group {
            margin: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .gallery-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .gallery-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .gallery-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .gallery-item img {
            width: 100%;
            height: 80px;
            object-fit: contain;
            border-radius: 4px;
        }

        .gallery-item .label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            text-align: center;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .canvas-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.5rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .tool-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:hover,
        .tool-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .asset-binding {
            padding: 1rem;
            display: none;
        }

        .asset-binding.active {
            display: block;
        }

        .binding-section {
            margin-bottom: 1.5rem;
        }

        .binding-section h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
        }

        .tag-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tag-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .tag-item:hover {
            background: #f0f4ff;
        }

        .tag-item.selected {
            background: #667eea;
            color: white;
        }

        .filters {
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .status-bar {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        #konva-container {
            width: 100%;
            height: 100%;
            background: #fff;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .metadata-display {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .real-time-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="pi pi-th-large"></i> Graphic Library Builder - Digital Twin Configuration</h1>
    </div>

    <!-- Top Toolbar -->
    <div class="top-toolbar">
        <button class="toolbar-btn primary" onclick="saveLayout()">
            <i class="pi pi-save"></i> Save Layout
        </button>
        <button class="toolbar-btn success" onclick="previewLive()">
            <i class="pi pi-play"></i> Preview Live
        </button>
        <button class="toolbar-btn" onclick="exportDiagram()">
            <i class="pi pi-download"></i> Export
        </button>
        <div style="margin-left: auto; display: flex; gap: 1rem; align-items: center;">
            <span style="font-size: 0.9rem; color: #666;">Drawing Mode:</span>
            <button class="toolbar-btn" id="drawingMode" onclick="toggleDrawingMode()">
                <i class="pi pi-pencil"></i> Connect
            </button>
            <button class="toolbar-btn" onclick="clearCanvas()">
                <i class="pi pi-trash"></i> Clear
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel: P&ID Symbol Library -->
        <div class="left-panel">
            <div class="panel-header">
                <i class="pi pi-th-large"></i> P&ID Symbol Library
            </div>
            
            <div class="symbol-library" id="symbolLibrary">
                <!-- Pumps & Compressors -->
                <div class="symbol-category">
                    <h3>Pumps & Compressors</h3>
                    <div class="symbol-grid">
                        <div class="symbol-item" draggable="true" data-symbol="centrifugal-pump">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="35" fill="#4CAF50" stroke="#333" stroke-width="2"/>
                                <path d="M25 50 L75 50 M50 25 L50 75" stroke="white" stroke-width="2"/>
                            </svg>
                            <div class="label">Pump</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="compressor">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="35" fill="#FF9800" stroke="#333" stroke-width="2"/>
                                <polygon points="35,35 65,35 50,65" fill="white"/>
                            </svg>
                            <div class="label">Compressor</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="fan">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="35" fill="#2196F3" stroke="#333" stroke-width="2"/>
                                <path d="M35 35 L65 65 M35 65 L65 35" stroke="white" stroke-width="3"/>
                            </svg>
                            <div class="label">Fan</div>
                        </div>
                    </div>
                </div>

                <!-- Valves -->
                <div class="symbol-category">
                    <h3>Valves</h3>
                    <div class="symbol-grid">
                        <div class="symbol-item" draggable="true" data-symbol="gate-valve">
                            <svg viewBox="0 0 100 100">
                                <polygon points="30,30 70,30 50,70" fill="#FF5722" stroke="#333" stroke-width="2"/>
                                <line x1="50" y1="30" x2="50" y2="15" stroke="#333" stroke-width="2"/>
                                <rect x="45" y="10" width="10" height="10" fill="#333"/>
                            </svg>
                            <div class="label">Gate Valve</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="ball-valve">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="25" fill="#9C27B0" stroke="#333" stroke-width="2"/>
                                <line x1="35" y1="35" x2="65" y2="65" stroke="white" stroke-width="3"/>
                            </svg>
                            <div class="label">Ball Valve</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="check-valve">
                            <svg viewBox="0 0 100 100">
                                <polygon points="30,40 70,40 70,60 30,60" fill="#607D8B" stroke="#333" stroke-width="2"/>
                                <polygon points="35,50 55,35 55,65" fill="white"/>
                            </svg>
                            <div class="label">Check Valve</div>
                        </div>
                    </div>
                </div>

                <!-- Vessels & Tanks -->
                <div class="symbol-category">
                    <h3>Vessels & Tanks</h3>
                    <div class="symbol-grid">
                        <div class="symbol-item" draggable="true" data-symbol="tank">
                            <svg viewBox="0 0 100 100">
                                <rect x="25" y="30" width="50" height="40" fill="#795548" stroke="#333" stroke-width="2"/>
                                <ellipse cx="50" cy="30" rx="25" ry="8" fill="#A1887F" stroke="#333" stroke-width="2"/>
                            </svg>
                            <div class="label">Tank</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="vessel">
                            <svg viewBox="0 0 100 100">
                                <ellipse cx="50" cy="50" rx="30" ry="35" fill="#8BC34A" stroke="#333" stroke-width="2"/>
                                <line x1="20" y1="50" x2="80" y2="50" stroke="#333" stroke-width="1"/>
                            </svg>
                            <div class="label">Vessel</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="column">
                            <svg viewBox="0 0 100 100">
                                <rect x="35" y="15" width="30" height="70" fill="#FF9800" stroke="#333" stroke-width="2"/>
                                <line x1="25" y1="30" x2="75" y2="30" stroke="#333" stroke-width="2"/>
                                <line x1="25" y1="50" x2="75" y2="50" stroke="#333" stroke-width="2"/>
                                <line x1="25" y1="70" x2="75" y2="70" stroke="#333" stroke-width="2"/>
                            </svg>
                            <div class="label">Column</div>
                        </div>
                    </div>
                </div>

                <!-- Heat Exchangers -->
                <div class="symbol-category">
                    <h3>Heat Exchangers</h3>
                    <div class="symbol-grid">
                        <div class="symbol-item" draggable="true" data-symbol="heat-exchanger">
                            <svg viewBox="0 0 100 100">
                                <rect x="15" y="30" width="70" height="40" fill="#2196F3" stroke="#333" stroke-width="2"/>
                                <line x1="15" y1="40" x2="85" y2="60" stroke="white" stroke-width="2"/>
                                <line x1="15" y1="60" x2="85" y2="40" stroke="white" stroke-width="2"/>
                            </svg>
                            <div class="label">Heat Exchanger</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="cooler">
                            <svg viewBox="0 0 100 100">
                                <rect x="20" y="35" width="60" height="30" fill="#00BCD4" stroke="#333" stroke-width="2"/>
                                <path d="M30 45 Q40 35 50 45 Q60 55 70 45" stroke="white" stroke-width="2" fill="none"/>
                            </svg>
                            <div class="label">Cooler</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="heater">
                            <svg viewBox="0 0 100 100">
                                <rect x="20" y="35" width="60" height="30" fill="#F44336" stroke="#333" stroke-width="2"/>
                                <path d="M30 45 L40 55 L50 45 L60 55 L70 45" stroke="white" stroke-width="2" fill="none"/>
                            </svg>
                            <div class="label">Heater</div>
                        </div>
                    </div>
                </div>

                <!-- Instruments -->
                <div class="symbol-category">
                    <h3>Instruments</h3>
                    <div class="symbol-grid">
                        <div class="symbol-item" draggable="true" data-symbol="temperature">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="30" fill="white" stroke="#333" stroke-width="2"/>
                                <text x="50" y="55" text-anchor="middle" font-size="20" fill="#333">T</text>
                            </svg>
                            <div class="label">Temperature</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="pressure">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="30" fill="white" stroke="#333" stroke-width="2"/>
                                <text x="50" y="55" text-anchor="middle" font-size="20" fill="#333">P</text>
                            </svg>
                            <div class="label">Pressure</div>
                        </div>
                        <div class="symbol-item" draggable="true" data-symbol="flow">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="30" fill="white" stroke="#333" stroke-width="2"/>
                                <text x="50" y="55" text-anchor="middle" font-size="20" fill="#333">F</text>
                            </svg>
                            <div class="label">Flow</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel: Canvas -->
        <div class="canvas-area">
            <div class="panel-header">
                <i class="pi pi-sitemap"></i> Canvas Builder
            </div>

            <div class="canvas-toolbar">
                <button class="tool-btn active" id="selectTool" onclick="setTool('select')">
                    <i class="pi pi-cursor"></i>
                </button>
                <button class="tool-btn" id="panTool" onclick="setTool('pan')">
                    <i class="pi pi-arrows-alt"></i>
                </button>
                <button class="tool-btn" onclick="zoomIn()">
                    <i class="pi pi-search-plus"></i>
                </button>
                <button class="tool-btn" onclick="zoomOut()">
                    <i class="pi pi-search-minus"></i>
                </button>
                <button class="tool-btn" onclick="resetView()">
                    <i class="pi pi-refresh"></i>
                </button>
                <div style="margin-left: auto;">
                    <label style="font-size: 0.8rem; margin-right: 0.5rem;">
                        <input type="checkbox" id="snapToGrid" checked> Snap to Grid
                    </label>
                </div>
            </div>

            <div class="canvas-container">
                <div id="konva-container"></div>
            </div>

            <div class="status-bar">
                <span id="canvasStatus">Ready - Drag symbols from library to canvas</span>
            </div>
        </div>

        <!-- Right Panel: Asset Binding Form -->
        <div class="right-panel">
            <div class="panel-header">
                <i class="pi pi-link"></i> Asset Binding
            </div>

            <div style="padding: 1rem; flex: 1;">
                <div id="assetBindingForm" style="display: none;">
                    <div class="form-group">
                        <label>Selected Symbol</label>
                        <div id="selectedSymbolInfo" style="background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-size: 0.9rem; color: #666;">
                            No symbol selected
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="assetDropdown">Asset Assignment</label>
                        <select id="assetDropdown" class="form-control">
                            <option value="">Select Asset</option>
                            <optgroup label="Pumps">
                                <option value="CP-101">CP-101 - Condensate Pump</option>
                                <option value="FW-201">FW-201 - Feed Water Pump</option>
                                <option value="BFP-301">BFP-301 - Boiler Feed Pump</option>
                            </optgroup>
                            <optgroup label="Valves">
                                <option value="VLV-401">VLV-401 - Control Valve</option>
                                <option value="VLV-402">VLV-402 - Isolation Valve</option>
                                <option value="PRV-501">PRV-501 - Pressure Relief Valve</option>
                            </optgroup>
                            <optgroup label="Heat Exchangers">
                                <option value="HX-301">HX-301 - Feed Water Heater</option>
                                <option value="HX-302">HX-302 - Condenser</option>
                                <option value="HX-303">HX-303 - Economizer</option>
                            </optgroup>
                            <optgroup label="Instruments">
                                <option value="TE-601">TE-601 - Temperature Element</option>
                                <option value="PE-602">PE-602 - Pressure Element</option>
                                <option value="FE-603">FE-603 - Flow Element</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tagDropdown">Telemetry Tag</label>
                        <select id="tagDropdown" class="form-control">
                            <option value="">Select Tag</option>
                            <optgroup label="Temperature Tags">
                                <option value="CP-101.TEMP">CP-101.Temperature</option>
                                <option value="FW-201.TEMP">FW-201.Temperature</option>
                                <option value="HX-301.TEMP_IN">HX-301.Inlet Temperature</option>
                                <option value="HX-301.TEMP_OUT">HX-301.Outlet Temperature</option>
                            </optgroup>
                            <optgroup label="Pressure Tags">
                                <option value="CP-101.PRESS">CP-101.Pressure</option>
                                <option value="FW-201.PRESS">FW-201.Pressure</option>
                                <option value="VLV-401.PRESS_UP">VLV-401.Upstream Pressure</option>
                                <option value="VLV-401.PRESS_DN">VLV-401.Downstream Pressure</option>
                            </optgroup>
                            <optgroup label="Flow Tags">
                                <option value="CP-101.FLOW">CP-101.Flow Rate</option>
                                <option value="FW-201.FLOW">FW-201.Flow Rate</option>
                                <option value="HX-301.FLOW">HX-301.Flow Rate</option>
                            </optgroup>
                            <optgroup label="Status Tags">
                                <option value="CP-101.STATUS">CP-101.Status</option>
                                <option value="VLV-401.POSITION">VLV-401.Position</option>
                                <option value="HX-301.STATUS">HX-301.Status</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="systemType">System Type</label>
                        <select id="systemType" class="form-control">
                            <option value="">Select System</option>
                            <option value="condensate">Condensate System</option>
                            <option value="feedwater">Feed Water System</option>
                            <option value="steam">Steam System</option>
                            <option value="cooling">Cooling Water System</option>
                            <option value="fuel">Fuel System</option>
                            <option value="air">Air System</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="enableRealTime">
                            Enable Real-time Updates
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Alarm Thresholds</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <input type="number" id="lowThreshold" class="form-control" placeholder="Low" style="font-size: 0.8rem;">
                            <input type="number" id="highThreshold" class="form-control" placeholder="High" style="font-size: 0.8rem;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" class="form-control" rows="2" placeholder="Add description or notes..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="applyBinding()" style="width: 100%; margin-bottom: 1rem;">
                        <i class="pi pi-check"></i> Apply Binding
                    </button>

                    <button class="btn" onclick="clearBinding()" style="width: 100%;">
                        <i class="pi pi-times"></i> Clear Binding
                    </button>
                </div>

                <div id="noSelectionPanel" style="text-align: center; color: #666; padding: 2rem 0;">
                    <i class="pi pi-info-circle" style="font-size: 2.5rem; margin-bottom: 1rem; color: #ccc;"></i>
                    <h4 style="color: #999; margin: 0 0 0.5rem 0;">No Symbol Selected</h4>
                    <p style="font-size: 0.9rem; margin: 0;">Click on a symbol in the canvas to configure its asset binding.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stage, layer, connectLayer;
        let currentTool = 'select';
        let selectedShape = null;
        let isDrawingMode = false;
        let connectionStart = null;
        let connections = [];
        let symbolCounter = 0;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            setupEventListeners();
            loadExampleDiagram();
            updateAssetBindingPanel();
        });

        function initializeCanvas() {
            const container = document.getElementById('konva-container');
            const containerRect = container.getBoundingClientRect();
            
            stage = new Konva.Stage({
                container: 'konva-container',
                width: containerRect.width,
                height: containerRect.height,
                draggable: false
            });

            // Create layers
            layer = new Konva.Layer();
            connectLayer = new Konva.Layer();
            stage.add(layer);
            stage.add(connectLayer);

            // Handle window resize
            window.addEventListener('resize', () => {
                const newRect = container.getBoundingClientRect();
                stage.width(newRect.width);
                stage.height(newRect.height);
            });

            // Handle canvas clicks
            stage.on('click', (e) => {
                if (isDrawingMode) {
                    handleConnectionClick(e);
                } else if (e.target === stage) {
                    selectShape(null);
                } else {
                    selectShape(e.target);
                }
            });

            // Handle drag and drop from symbol library
            stage.on('dragover', (e) => {
                e.evt.preventDefault();
            });

            stage.on('drop', (e) => {
                e.evt.preventDefault();
                const symbolType = e.evt.dataTransfer.getData('text/plain');
                if (symbolType) {
                    addSymbolToCanvas(symbolType, stage.getPointerPosition());
                }
            });
        }

        function setupEventListeners() {
            // P&ID Symbol library drag and drop
            const symbolItems = document.querySelectorAll('.symbol-item');
            symbolItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const symbolType = e.target.closest('.symbol-item').getAttribute('data-symbol');
                    e.dataTransfer.setData('text/plain', symbolType);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });

            // Asset binding form events
            document.getElementById('assetDropdown').addEventListener('change', updateBindingPreview);
            document.getElementById('tagDropdown').addEventListener('change', updateBindingPreview);
            document.getElementById('systemType').addEventListener('change', updateBindingPreview);
            document.getElementById('enableRealTime').addEventListener('change', updateBindingPreview);
        }

        // Create P&ID symbol on canvas
        function addSymbolToCanvas(symbolType, position) {
            symbolCounter++;
            const symbolId = `${symbolType}-${symbolCounter}`;
            
            // Create the symbol based on type
            const symbol = createPIDSymbol(symbolType, position || { x: 150, y: 150 });
            symbol.setAttr('symbolType', symbolType);
            symbol.setAttr('symbolId', symbolId);
            symbol.setAttr('name', 'symbol');
            symbol.draggable(true);

            // Snap to grid if enabled
            if (document.getElementById('snapToGrid').checked) {
                symbol.on('dragmove', snapToGrid);
            }

            // Add connection points
            addConnectionPoints(symbol);

            layer.add(symbol);
            layer.draw();

            // Select the newly added symbol
            selectShape(symbol);
            
            updateCanvasStatus(`Added ${symbolType} to canvas`);
        }

        // Create P&ID symbol graphics
        function createPIDSymbol(type, position) {
            const group = new Konva.Group({
                x: position.x,
                y: position.y
            });

            switch(type) {
                case 'centrifugal-pump':
                    const pumpCircle = new Konva.Circle({
                        radius: 35,
                        fill: '#4CAF50',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const pumpCross = new Konva.Shape({
                        sceneFunc: function (context, shape) {
                            context.beginPath();
                            context.moveTo(-25, 0);
                            context.lineTo(25, 0);
                            context.moveTo(0, -25);
                            context.lineTo(0, 25);
                            context.fillStrokeShape(shape);
                        },
                        stroke: 'white',
                        strokeWidth: 2
                    });
                    group.add(pumpCircle, pumpCross);
                    break;

                case 'gate-valve':
                    const valveBody = new Konva.RegularPolygon({
                        sides: 3,
                        radius: 25,
                        fill: '#FF5722',
                        stroke: '#333',
                        strokeWidth: 2,
                        rotation: 180
                    });
                    const valveStem = new Konva.Line({
                        points: [0, -25, 0, -40],
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const valveHandle = new Konva.Rect({
                        x: -5,
                        y: -45,
                        width: 10,
                        height: 10,
                        fill: '#333'
                    });
                    group.add(valveBody, valveStem, valveHandle);
                    break;

                case 'tank':
                    const tankBody = new Konva.Rect({
                        x: -25,
                        y: -20,
                        width: 50,
                        height: 40,
                        fill: '#795548',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const tankTop = new Konva.Ellipse({
                        radiusX: 25,
                        radiusY: 8,
                        y: -20,
                        fill: '#A1887F',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    group.add(tankBody, tankTop);
                    break;

                case 'heat-exchanger':
                    const hxBody = new Konva.Rect({
                        x: -35,
                        y: -20,
                        width: 70,
                        height: 40,
                        fill: '#2196F3',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const hxLine1 = new Konva.Line({
                        points: [-35, -10, 35, 10],
                        stroke: 'white',
                        strokeWidth: 2
                    });
                    const hxLine2 = new Konva.Line({
                        points: [-35, 10, 35, -10],
                        stroke: 'white',
                        strokeWidth: 2
                    });
                    group.add(hxBody, hxLine1, hxLine2);
                    break;

                case 'temperature':
                    const tempCircle = new Konva.Circle({
                        radius: 30,
                        fill: 'white',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const tempText = new Konva.Text({
                        text: 'T',
                        fontSize: 20,
                        fill: '#333',
                        x: -7,
                        y: -10
                    });
                    group.add(tempCircle, tempText);
                    break;

                case 'pressure':
                    const pressCircle = new Konva.Circle({
                        radius: 30,
                        fill: 'white',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    const pressText = new Konva.Text({
                        text: 'P',
                        fontSize: 20,
                        fill: '#333',
                        x: -7,
                        y: -10
                    });
                    group.add(pressCircle, pressText);
                    break;

                // Add more symbol types as needed
                default:
                    const defaultShape = new Konva.Rect({
                        width: 60,
                        height: 40,
                        fill: '#ddd',
                        stroke: '#333',
                        strokeWidth: 2,
                        x: -30,
                        y: -20
                    });
                    group.add(defaultShape);
            }

            return group;
        }

        // Add connection points to symbols
        function addConnectionPoints(symbol) {
            const connectionPoints = [
                { x: -40, y: 0, id: 'left' },
                { x: 40, y: 0, id: 'right' },
                { x: 0, y: -40, id: 'top' },
                { x: 0, y: 40, id: 'bottom' }
            ];

            connectionPoints.forEach(point => {
                const connector = new Konva.Circle({
                    x: point.x,
                    y: point.y,
                    radius: 4,
                    fill: '#667eea',
                    stroke: 'white',
                    strokeWidth: 2,
                    visible: false,
                    name: 'connector',
                    connectionId: point.id
                });

                symbol.add(connector);
            });
        }

        function selectShape(shape) {
            // Remove previous selection
            if (selectedShape) {
                selectedShape.stroke(null);
                selectedShape.strokeWidth(0);
            }

            selectedShape = shape;

            if (shape && shape.name() === 'symbol') {
                // Highlight selected shape
                shape.stroke('#667eea');
                shape.strokeWidth(2);
                
                // Update asset binding panel
                updateAssetBindingPanel(shape);
            } else {
                updateAssetBindingPanel(null);
            }

            layer.draw();
        }

        function updateAssetBindingPanel(shape = null) {
            const bindingForm = document.getElementById('assetBindingForm');
            const noSelectionPanel = document.getElementById('noSelectionPanel');

            if (shape && shape.name() === 'symbol') {
                bindingForm.style.display = 'block';
                noSelectionPanel.style.display = 'none';

                // Show connection points when selected
                const connectors = shape.find('.connector');
                connectors.forEach(connector => connector.visible(true));

                document.getElementById('selectedSymbolInfo').innerHTML = `
                    <strong>${shape.getAttr('symbolId') || 'Unknown Symbol'}</strong><br>
                    <small>Type: ${shape.getAttr('symbolType') || 'Unknown'}</small>
                `;

                // Pre-fill bound data if exists
                const boundAsset = shape.getAttr('boundAsset');
                const boundTag = shape.getAttr('boundTag');
                const boundSystem = shape.getAttr('boundSystem');
                
                if (boundAsset) document.getElementById('assetDropdown').value = boundAsset;
                if (boundTag) document.getElementById('tagDropdown').value = boundTag;
                if (boundSystem) document.getElementById('systemType').value = boundSystem;
                
                document.getElementById('enableRealTime').checked = shape.getAttr('realTimeEnabled') || false;
            } else {
                bindingForm.style.display = 'none';
                noSelectionPanel.style.display = 'block';

                // Hide all connection points
                layer.find('.connector').forEach(connector => connector.visible(false));
            }
            
            layer.draw();
        }

        function updateBindingPreview() {
            // This function can be used to show live preview of binding settings
            // For now, it's just a placeholder for future functionality
        }

        function applyBinding() {
            if (!selectedShape) {
                showNotification('Please select a symbol first.', 'warning');
                return;
            }

            const asset = document.getElementById('assetDropdown').value;
            const tag = document.getElementById('tagDropdown').value;
            const system = document.getElementById('systemType').value;
            const realTime = document.getElementById('enableRealTime').checked;
            const lowThreshold = document.getElementById('lowThreshold').value;
            const highThreshold = document.getElementById('highThreshold').value;
            const description = document.getElementById('description').value;

            if (!asset || !tag) {
                showNotification('Please select both an asset and a telemetry tag.', 'warning');
                return;
            }

            // Store binding data
            selectedShape.setAttr('boundAsset', asset);
            selectedShape.setAttr('boundTag', tag);
            selectedShape.setAttr('boundSystem', system);
            selectedShape.setAttr('realTimeEnabled', realTime);
            selectedShape.setAttr('lowThreshold', lowThreshold);
            selectedShape.setAttr('highThreshold', highThreshold);
            selectedShape.setAttr('description', description);

            // Add visual indicator for bound symbols
            if (realTime) {
                // Remove existing indicator
                const existingIndicator = selectedShape.findOne('.realtime-indicator');
                if (existingIndicator) {
                    existingIndicator.destroy();
                }

                const indicator = new Konva.Circle({
                    x: 35,
                    y: -35,
                    radius: 4,
                    fill: '#28a745',
                    name: 'realtime-indicator'
                });
                
                // Animate the indicator
                const anim = new Konva.Animation((frame) => {
                    indicator.opacity(0.5 + 0.5 * Math.sin(frame.time * 0.005));
                }, layer);
                anim.start();

                selectedShape.add(indicator);
            }

            layer.draw();
            showNotification(`Binding applied: ${asset} â†’ ${tag}`);
        }

        function clearBinding() {
            if (!selectedShape) {
                showNotification('Please select a symbol first.', 'warning');
                return;
            }

            // Clear binding data
            selectedShape.setAttr('boundAsset', null);
            selectedShape.setAttr('boundTag', null);
            selectedShape.setAttr('boundSystem', null);
            selectedShape.setAttr('realTimeEnabled', false);
            selectedShape.setAttr('lowThreshold', null);
            selectedShape.setAttr('highThreshold', null);
            selectedShape.setAttr('description', null);

            // Remove indicator
            const indicator = selectedShape.findOne('.realtime-indicator');
            if (indicator) {
                indicator.destroy();
            }

            // Clear form
            document.getElementById('assetDropdown').value = '';
            document.getElementById('tagDropdown').value = '';
            document.getElementById('systemType').value = '';
            document.getElementById('enableRealTime').checked = false;
            document.getElementById('lowThreshold').value = '';
            document.getElementById('highThreshold').value = '';
            document.getElementById('description').value = '';

            layer.draw();
            showNotification('Binding cleared');
        }

        // Toolbar functions
        function saveLayout() {
            const layoutData = {
                symbols: [],
                connections: connections,
                timestamp: new Date().toISOString()
            };

            // Collect symbol data
            layer.find('.symbol').forEach(symbol => {
                layoutData.symbols.push({
                    id: symbol.getAttr('symbolId'),
                    type: symbol.getAttr('symbolType'),
                    x: symbol.x(),
                    y: symbol.y(),
                    boundAsset: symbol.getAttr('boundAsset'),
                    boundTag: symbol.getAttr('boundTag'),
                    boundSystem: symbol.getAttr('boundSystem'),
                    realTimeEnabled: symbol.getAttr('realTimeEnabled'),
                    description: symbol.getAttr('description')
                });
            });

            // Save to localStorage (in a real app, this would go to Firestore)
            localStorage.setItem('pid_layout', JSON.stringify(layoutData));
            showNotification('Layout saved successfully!');
        }

        function previewLive() {
            // Toggle real-time simulation
            const boundSymbols = layer.find('.symbol').filter(symbol => symbol.getAttr('realTimeEnabled'));
            
            if (boundSymbols.length === 0) {
                showNotification('No symbols with real-time data enabled. Please bind some symbols first.', 'warning');
                return;
            }

            showNotification(`Preview mode activated for ${boundSymbols.length} symbols`);
            
            // Start real-time simulation for bound symbols
            boundSymbols.forEach(symbol => {
                simulateRealTimeData(symbol);
            });
        }

        function exportDiagram() {
            // Export canvas as image
            const dataURL = stage.toDataURL({ pixelRatio: 2 });
            
            // Create download link
            const link = document.createElement('a');
            link.download = `pid-diagram-${new Date().toISOString().split('T')[0]}.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Diagram exported as PNG');
        }

        function toggleDrawingMode() {
            isDrawingMode = !isDrawingMode;
            const btn = document.getElementById('drawingMode');
            
            if (isDrawingMode) {
                btn.classList.add('primary');
                btn.innerHTML = '<i class="pi pi-times"></i> Exit Connect';
                updateCanvasStatus('Connection mode: Click on symbols to connect them');
            } else {
                btn.classList.remove('primary');
                btn.innerHTML = '<i class="pi pi-pencil"></i> Connect';
                connectionStart = null;
                updateCanvasStatus('Selection mode: Click on symbols to configure');
            }
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear the entire canvas?')) {
                layer.destroyChildren();
                connectLayer.destroyChildren();
                connections = [];
                selectedShape = null;
                symbolCounter = 0;
                updateAssetBindingPanel();
                layer.draw();
                connectLayer.draw();
                showNotification('Canvas cleared');
            }
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');

            stage.draggable(tool === 'pan');
            updateCanvasStatus(`Tool: ${tool.charAt(0).toUpperCase() + tool.slice(1)}`);
        }

        function snapToGrid(e) {
            const gridSize = 20;
            e.target.x(Math.round(e.target.x() / gridSize) * gridSize);
            e.target.y(Math.round(e.target.y() / gridSize) * gridSize);
        }

        function zoomIn() {
            const scaleBy = 1.2;
            const stage = layer.getStage();
            const oldScale = stage.scaleX();
            stage.scale({ x: oldScale * scaleBy, y: oldScale * scaleBy });
            stage.batchDraw();
        }

        function zoomOut() {
            const scaleBy = 1.2;
            const stage = layer.getStage();
            const oldScale = stage.scaleX();
            stage.scale({ x: oldScale / scaleBy, y: oldScale / scaleBy });
            stage.batchDraw();
        }

        function resetView() {
            stage.scale({ x: 1, y: 1 });
            stage.position({ x: 0, y: 0 });
            stage.batchDraw();
            updateCanvasStatus('View reset to default');
        }

        function updateCanvasStatus(message) {
            document.getElementById('canvasStatus').textContent = message;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="pi pi-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Connection handling
        function handleConnectionClick(e) {
            if (e.target.name() !== 'symbol') return;

            const symbol = e.target;
            
            if (!connectionStart) {
                connectionStart = symbol;
                symbol.stroke('#FF5722');
                symbol.strokeWidth(3);
                layer.draw();
                updateCanvasStatus('Select target symbol to connect');
            } else if (connectionStart !== symbol) {
                createConnection(connectionStart, symbol);
                connectionStart.stroke('#667eea');
                connectionStart.strokeWidth(2);
                connectionStart = null;
                updateCanvasStatus('Connection created! Click symbols to create more connections');
                layer.draw();
            }
        }

        function createConnection(startSymbol, endSymbol) {
            const startPos = startSymbol.getAbsolutePosition();
            const endPos = endSymbol.getAbsolutePosition();

            const line = new Konva.Line({
                points: [startPos.x, startPos.y, endPos.x, endPos.y],
                stroke: '#333',
                strokeWidth: 3,
                name: 'connection'
            });

            connectLayer.add(line);
            connectLayer.draw();

            // Store connection data
            connections.push({
                id: `conn-${connections.length + 1}`,
                start: startSymbol.getAttr('symbolId'),
                end: endSymbol.getAttr('symbolId'),
                line: line
            });

            showNotification(`Connected ${startSymbol.getAttr('symbolId')} to ${endSymbol.getAttr('symbolId')}`);
        }

        // Real-time data simulation
        function simulateRealTimeData(symbol) {
            const tag = symbol.getAttr('boundTag');
            const lowThreshold = parseFloat(symbol.getAttr('lowThreshold')) || 0;
            const highThreshold = parseFloat(symbol.getAttr('highThreshold')) || 100;

            // Simulate sensor reading
            const value = Math.random() * (highThreshold - lowThreshold) + lowThreshold;
            
            // Color coding based on thresholds
            if (value > highThreshold * 0.9) {
                symbol.opacity(0.8);
                symbol.getChildren().forEach(child => {
                    if (child.fill) child.fill('#FF5722'); // Red for high
                });
            } else if (value < lowThreshold * 1.1) {
                symbol.opacity(0.8);
                symbol.getChildren().forEach(child => {
                    if (child.fill) child.fill('#2196F3'); // Blue for low
                });
            } else {
                symbol.opacity(1);
                symbol.getChildren().forEach(child => {
                    if (child.fill && child.name() !== 'realtime-indicator') {
                        // Reset to original colors based on symbol type
                        const symbolType = symbol.getAttr('symbolType');
                        switch(symbolType) {
                            case 'centrifugal-pump':
                                child.fill('#4CAF50');
                                break;
                            case 'gate-valve':
                                child.fill('#FF5722');
                                break;
                            case 'tank':
                                child.fill('#795548');
                                break;
                            case 'heat-exchanger':
                                child.fill('#2196F3');
                                break;
                            default:
                                child.fill('#ddd');
                        }
                    }
                });
            }
            
            layer.draw();
        }

        // Load example P&ID diagram
        function loadExampleDiagram() {
            // Create example symbols to demonstrate the interface
            setTimeout(() => {
                addSymbolToCanvas('centrifugal-pump', { x: 200, y: 200 });
                setTimeout(() => addSymbolToCanvas('gate-valve', { x: 350, y: 200 }), 500);
                setTimeout(() => addSymbolToCanvas('heat-exchanger', { x: 500, y: 200 }), 1000);
                setTimeout(() => addSymbolToCanvas('tank', { x: 650, y: 200 }), 1500);
                setTimeout(() => addSymbolToCanvas('temperature', { x: 500, y: 100 }), 2000);
            }, 1000);
        }

        // Auto real-time data updates
        setInterval(() => {
            const boundSymbols = layer.find('.symbol').filter(shape => shape.getAttr('realTimeEnabled'));
            boundSymbols.forEach(symbol => {
                simulateRealTimeData(symbol);
            });
        }, 3000);
    </script>
</body>
</html>